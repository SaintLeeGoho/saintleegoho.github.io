<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka分布式消息系统入门 | GohoLee</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="blog by GohoLee">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.15bca8c4.css" as="style"><link rel="preload" href="/assets/js/app.4c955a77.js" as="script"><link rel="preload" href="/assets/js/4.1f64e010.js" as="script"><link rel="preload" href="/assets/js/1.2b09ee83.js" as="script"><link rel="preload" href="/assets/js/10.08341258.js" as="script"><link rel="prefetch" href="/assets/js/11.44b1e064.js"><link rel="prefetch" href="/assets/js/12.46caf217.js"><link rel="prefetch" href="/assets/js/13.2a24eef2.js"><link rel="prefetch" href="/assets/js/14.18303fff.js"><link rel="prefetch" href="/assets/js/15.eb41772c.js"><link rel="prefetch" href="/assets/js/16.dbac35fb.js"><link rel="prefetch" href="/assets/js/17.3881a037.js"><link rel="prefetch" href="/assets/js/18.a6042dc9.js"><link rel="prefetch" href="/assets/js/19.f1b368c9.js"><link rel="prefetch" href="/assets/js/20.305a152a.js"><link rel="prefetch" href="/assets/js/21.f54a0bb0.js"><link rel="prefetch" href="/assets/js/22.e026b642.js"><link rel="prefetch" href="/assets/js/3.c860fb87.js"><link rel="prefetch" href="/assets/js/5.7d1d4fdd.js"><link rel="prefetch" href="/assets/js/6.6b47eb9b.js"><link rel="prefetch" href="/assets/js/7.1e7dcb9a.js"><link rel="prefetch" href="/assets/js/8.ff9809b2.js"><link rel="prefetch" href="/assets/js/9.30f2afa9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.15bca8c4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>GohoLee</h3> <p class="description" data-v-59e6cb88>blog by GohoLee</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>GohoLee</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.png" alt="GohoLee" class="logo"> <span class="site-name">GohoLee</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Big Data/" class="nav-link"><i class="undefined"></i>
  Big Data
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端基础/" class="nav-link"><i class="undefined"></i>
  前端基础
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      文档Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/Saint/" class="nav-link"><i class="undefined"></i>
  关于博主
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/saintleegoho" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    GohoLee
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>11</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Big Data/" class="nav-link"><i class="undefined"></i>
  Big Data
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端基础/" class="nav-link"><i class="undefined"></i>
  前端基础
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      文档Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/Saint/" class="nav-link"><i class="undefined"></i>
  关于博主
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/saintleegoho" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Kafka分布式消息系统入门</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>GohoLee</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Kafka分布式消息系统入门</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>GohoLee</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>7/20/2023</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>Kafka</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="kafka"><a href="#kafka" class="header-anchor">#</a> Kafka</h1> <h2 id="第1章-kafka概述"><a href="#第1章-kafka概述" class="header-anchor">#</a> 第1章 Kafka概述</h2> <h3 id="_1-1-kafka是什么"><a href="#_1-1-kafka是什么" class="header-anchor">#</a> 1.1 Kafka是什么</h3> <p>在流式计算中，Kafka一般用来缓存数据，Storm和Spark通过消费Kafka的数据进行计算。</p> <p>1）Apache Kafka是一个开源消息系统，由Scala写成。是由Apache软件基金会开发的一个开源消息系统项目。</p> <p>2）Kafka最初是由LinkedIn公司开发，并于2011年初开源。2012年10月Kafka从Apache Incubator毕业。该项目的目标是为处理实时数据提供一个统一、高通量、低等待的平台。</p> <p>3）Kafka是一个分布式消息队列。Kafka对消息保存时根据Topic进行归类，发送消息者称为Producer，消息接受者称为Consumer，此外kafka集群有多个kafka实例组成，每个实例(server)成为broker。</p> <p>4）无论是kafka集群，还是consumer都依赖于zookeeper集群保存一些meta信息，来保证系统可用性。</p> <h3 id="_1-2-消息队列内部实现原理"><a href="#_1-2-消息队列内部实现原理" class="header-anchor">#</a> 1.2 消息队列内部实现原理</h3> <p>消息队列内部实现原理如图所示。</p> <p><img src="/assets/img/消息队列内部实现原理.4caef420.png" alt="img"></p> <p>（1）点对点模式（一对一，消费者主动拉取数据，消息收到后消息清除）</p> <p>点对点模型通常是一个基于拉取或者轮询的消息传送模型，这种模型从队列中请求信息，而不是将消息推送到客户端。这个模型的特点是发送到队列的消息被一个且只有一个接收者接收处理，即使有多个消息监听者也是如此。</p> <p>（2）发布/订阅模式（一对多，数据生产后，推送给所有订阅者）</p> <p>发布订阅模型则是一个基于推送的消息传送模型。发布订阅模型可以有多种不同的订阅者，临时订阅者只在主动监听主题时才接收消息，而持久订阅者则监听主题的所有消息，即使当前订阅者不可用，处于离线状态。</p> <h3 id="_1-3-为什么需要消息队列"><a href="#_1-3-为什么需要消息队列" class="header-anchor">#</a> 1.3 为什么需要消息队列</h3> <p>1．解耦</p> <p>允许你独立的扩展或修改两边的处理过程，只要确保它们遵守同样的接口约束。</p> <p>2．冗余</p> <p>消息队列把数据进行持久化直到它们已经被完全处理，通过这一方式规避了数据丢失风险。许多消息队列所采用的&quot;插入-获取-删除&quot;范式中，在把一个消息从队列中删除之前，需要你的处理系统明确的指出该消息已经被处理完毕，从而确保你的数据被安全的保存直到你使用完毕。</p> <p>3．扩展性</p> <p>因为消息队列解耦了你的处理过程，所以增大消息入队和处理的频率是很容易的，只要另外增加处理过程即可。</p> <p>4．灵活性 &amp; 峰值处理能力</p> <p>在访问量剧增的情况下，应用仍然需要继续发挥作用，但是这样的突发流量并不常见。如果为以能处理这类峰值访问为标准来投入资源随时待命无疑是巨大的浪费。使用消息队列能够使关键组件顶住突发的访问压力，而不会因为突发的超负荷的请求而完全崩溃。</p> <p>5．可恢复性</p> <p>系统的一部分组件失效时，不会影响到整个系统。消息队列降低了进程间的耦合度，所以即使一个处理消息的进程挂掉，加入队列中的消息仍然可以在系统恢复后被处理。</p> <p>6．顺序保证</p> <p>在大多使用场景下，数据处理的顺序都很重要。大部分消息队列本来就是排序的，并且能保证数据会按照特定的顺序来处理。（Kafka保证一个Partition内的消息的有序性）</p> <p>7．缓冲</p> <p>有助于控制和优化数据流经过系统的速度，解决生产消息和消费消息的处理速度不一致的情况。</p> <p>8．异步通信</p> <p>很多时候，用户不想也不需要立即处理消息。消息队列提供了异步处理机制，允许用户把一个消息放入队列，但并不立即处理它。想向队列中放入多少消息就放多少，然后在需要的时候再去处理它们。</p> <h3 id="_1-4-kafka架构"><a href="#_1-4-kafka架构" class="header-anchor">#</a> 1.4 Kafka架构</h3> <p>Kafka架构如图所示</p> <p><img src="/assets/img/Kafka架构.842e2816.png" alt="img"></p> <p>1）Producer ：消息生产者，就是向kafka broker发消息的客户端；</p> <p>2）Consumer ：消息消费者，向kafka broker取消息的客户端；</p> <p>3）Topic ：可以理解为一个队列；</p> <p>4）Consumer Group（CG）：这是kafka用来实现一个topic消息的广播（发给所有的consumer）和单播（发给任意一个consumer）的手段。一个topic可以有多个CG。topic的消息会复制（不是真的复制，是概念上的）到所有的CG，但每个partition只会把消息发给该CG中的一个consumer。如果需要实现广播，只要每个consumer有一个独立的CG就可以了。要实现单播只要所有的consumer在同一个CG。用CG还可以将consumer进行自由的分组而不需要多次发送消息到不同的topic；</p> <p>5）Broker ：一台kafka服务器就是一个broker。一个集群由多个broker组成。一个broker可以容纳多个topic；</p> <p>6）Partition：为了实现扩展性，一个非常大的topic可以分布到多个broker（即服务器）上，一个topic可以分为多个partition，每个partition是一个有序的队列。partition中的每条消息都会被分配一个有序的id（offset）。kafka只保证按一个partition中的顺序将消息发给consumer，不保证一个topic的整体（多个partition间）的顺序；</p> <p>7）Offset：kafka的存储文件都是按照offset.kafka来命名，用offset做名字的好处是方便查找。例如你想找位于2049的位置，只要找到2048.kafka的文件即可。当然the first offset就是00000000000.kafka。</p> <h2 id="第2章-kafka集群部署"><a href="#第2章-kafka集群部署" class="header-anchor">#</a> 第2章 Kafka集群部署</h2> <h3 id="_2-1-环境准备"><a href="#_2-1-环境准备" class="header-anchor">#</a> 2.1 环境准备</h3> <h4 id="_2-1-1-集群规划"><a href="#_2-1-1-集群规划" class="header-anchor">#</a> 2.1.1 集群规划</h4> <p>表8-1</p> <table><thead><tr><th>hadoop01</th> <th>hadoop02</th> <th>hadoop03</th></tr></thead> <tbody><tr><td>zk</td> <td>zk</td> <td>zk</td></tr> <tr><td>kafka</td> <td>kafka</td> <td>kafka</td></tr></tbody></table> <h4 id="_2-1-2-jar包下载"><a href="#_2-1-2-jar包下载" class="header-anchor">#</a> 2.1.2 jar包下载</h4> <p>下载地址：http://kafka.apache.org/downloads.html，如图所示</p> <p><img src="/assets/img/Kafka官方下载.d0f5476a.png" alt="image-20230720093639404"></p> <h4 id="_2-1-5-安装zookeeper"><a href="#_2-1-5-安装zookeeper" class="header-anchor">#</a> 2.1.5 安装Zookeeper</h4> <p>1．集群规划</p> <p>在hadoop01、hadoop02和hadoop03三个节点上部署Zookeeper。</p> <p>2．解压安装</p> <p>（1）解压zookeeper安装包到/opt/module/目录下</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 software<span class="token punctuation">]</span><span class="token comment"># tar -zxvf zookeeper-3.4.10.tar.gz -C /opt/module/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>（2）在/opt/module/zookeeper-3.4.10/这个目录下创建data</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 zookeeper-3.4.10<span class="token punctuation">]</span><span class="token comment"># mkdir -p data</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>（3）重命名/opt/module/zookeeper-3.4.10/conf这个目录下的zoo_sample.cfg为zoo.cfg</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 conf<span class="token punctuation">]</span><span class="token comment"># mv zoo_sample.cfg zoo.cfg</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3．配置zoo.cfg文件</p> <p>（1）具体配置</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/opt/module/zookeeper-3.4.10/data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>增加如下配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>##cluster##
server.1=hadoop01:2888:3888
server.2=hadoop02:2888:3888
server.3=hadoop03:2888:3888
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>（2）配置参数解读</p> <p>Server.A=B:C:D</p> <p>A是一个数字，表示这个是第几号服务器；</p> <p>B是这个服务器的ip地址；</p> <p>C是这个服务器与集群中的Leader服务器交换信息的端口；</p> <p>D是万一集群中的Leader服务器挂了，需要一个端口来重新进行选举，选出一个新的Leader，而这个端口就是用来执行选举时服务器相互通信的端口。</p> <p>集群模式下配置一个文件myid，这个文件在dataDir目录下，这个文件里面有一个数据就是A的值，Zookeeper启动时读取此文件，拿到里面的数据与zoo.cfg里面的配置信息比较从而判断到底是哪个server。</p> <p>4．集群操作</p> <p>（1）在/opt/module/zookeeper-3.4.10/data目录下创建一个myid的文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 data<span class="token punctuation">]</span><span class="token comment"># touch myid</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>添加myid文件，注意一定要在linux里面创建，在notepad++里面很可能乱码</p> <p>（2）编辑myid文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 data<span class="token punctuation">]</span><span class="token comment"># vi myid</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在文件中添加与server对应的编号：如hadoop01写1</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 data<span class="token punctuation">]</span><span class="token comment"># echo 1 &gt; myid </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>（3）拷贝配置好的zookeeper到其他机器上</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">scp</span> <span class="token parameter variable">-r</span> zookeeper-3.4.10/ root@hadoop01:/opt/module/

<span class="token function">scp</span> <span class="token parameter variable">-r</span> zookeeper-3.4.10/ root@hadoop03:/opt/module/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>并分别修改myid文件中内容为2、3</p> <p>（4）分别启动zookeeper</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 zookeeper-3.4.10<span class="token punctuation">]</span><span class="token comment"># bin/zkServer.sh start</span>

<span class="token punctuation">[</span>root@hadoop02 zookeeper-3.4.10<span class="token punctuation">]</span><span class="token comment"># bin/zkServer.sh start</span>

<span class="token punctuation">[</span>root@hadoop03 zookeeper-3.4.10<span class="token punctuation">]</span><span class="token comment"># bin/zkServer.sh start</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>（5）查看状态</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 zookeeper-3.4.10<span class="token punctuation">]</span><span class="token comment"># bin/zkServer.sh status</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>JMX enabled by default

Using config: /opt/module/zookeeper-3.4.10/bin/../conf/zoo.cfg

Mode: follower
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop02 zookeeper-3.4.10<span class="token punctuation">]</span><span class="token comment"># bin/zkServer.sh status</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>JMX enabled by default

Using config: /opt/module/zookeeper-3.4.10/bin/../conf/zoo.cfg

Mode: leader
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop03 zookeeper-3.4.10<span class="token punctuation">]</span><span class="token comment"># bin/zkServer.sh status</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>JMX enabled by default

Using config: /opt/module/zookeeper-3.4.10/bin/../conf/zoo.cfg

Mode: follower
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_2-2-kafka集群部署"><a href="#_2-2-kafka集群部署" class="header-anchor">#</a> 2.2 Kafka集群部署</h3> <p>1．解压安装包</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 software<span class="token punctuation">]</span><span class="token comment"># tar -zxvf kafka_2.11-0.11.0.0.tgz -C /opt/module/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2．修改解压后的文件名称</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 module<span class="token punctuation">]</span><span class="token comment"># mv kafka_2.11-0.11.0.0/ kafka</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3．在/opt/module/kafka目录下创建logs文件夹</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># mkdir logs</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>4．修改配置文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># cd config</span>
<span class="token punctuation">[</span>root@hadoop01 config<span class="token punctuation">]</span><span class="token comment"># vi server.properties</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修改以下内容：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#broker的全局唯一编号，不能重复（改）</span>
<span class="token key attr-name">broker.id</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span class="token comment">#删除topic功能使能（改）</span>
<span class="token key attr-name">delete.topic.enable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#处理网络请求的线程数量</span>
<span class="token key attr-name">num.network.threads</span><span class="token punctuation">=</span><span class="token value attr-value">3</span>
<span class="token comment">#用来处理磁盘IO的线程数量</span>
<span class="token key attr-name">num.io.threads</span><span class="token punctuation">=</span><span class="token value attr-value">8</span>
<span class="token comment">#发送套接字的缓冲区大小</span>
<span class="token key attr-name">socket.send.buffer.bytes</span><span class="token punctuation">=</span><span class="token value attr-value">102400</span>
<span class="token comment">#接收套接字的缓冲区大小</span>
<span class="token key attr-name">socket.receive.buffer.bytes</span><span class="token punctuation">=</span><span class="token value attr-value">102400</span>
<span class="token comment">#请求套接字的缓冲区大小</span>
<span class="token key attr-name">socket.request.max.bytes</span><span class="token punctuation">=</span><span class="token value attr-value">104857600</span>
<span class="token comment">#kafka运行日志存放的路径（改）</span>
<span class="token key attr-name">log.dirs</span><span class="token punctuation">=</span><span class="token value attr-value">/opt/module/kafka/logs</span>
<span class="token comment">#topic在当前broker上的分区个数</span>
<span class="token key attr-name">num.partitions</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token comment">#用来恢复和清理data下数据的线程数量</span>
<span class="token key attr-name">num.recovery.threads.per.data.dir</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token comment">#segment文件保留的最长时间，超时将被删除</span>
<span class="token key attr-name">log.retention.hours</span><span class="token punctuation">=</span><span class="token value attr-value">168</span>
<span class="token comment">#配置连接Zookeeper集群地址（改）</span>
<span class="token key attr-name">zookeeper.connect</span><span class="token punctuation">=</span><span class="token value attr-value">hadoop01:2181,hadoop02:2181,hadoop03:2181</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>5．配置环境变量</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 module<span class="token punctuation">]</span><span class="token comment"># vi /etc/profile</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>#KAFKA_HOME
export KAFKA_HOME=/opt/module/kafka
export PATH=$PATH:$KAFKA_HOME/bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>环境变量生效：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 module<span class="token punctuation">]</span><span class="token comment"># source /etc/profile</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>6．分发安装包，同步到hadoop02，hadoop03</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 etc<span class="token punctuation">]</span><span class="token comment"># xsync profile</span>
<span class="token punctuation">[</span>root@hadoop01 module<span class="token punctuation">]</span><span class="token comment"># xsync kafka/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>7．修改broker.id</p> <p>分别在hadoop02和hadoop03上修改配置文件/opt/module/kafka/config/server.properties中的broker.id=1、broker.id=2</p> <p>注：broker.id不得重复</p> <p>8．启动集群</p> <p>依次在hadoop01、hadoop02、hadoop03节点上启动kafka，</p> <p>&amp;的作用是使kafka在后台运行，让命令行得以继续</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-server-start.sh config/server.properties &amp;</span>

<span class="token punctuation">[</span>root@hadoop02 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-server-start.sh config/server.properties &amp;</span>

<span class="token punctuation">[</span>root@hadoop03 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-server-start.sh config/server.properties &amp;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>9．关闭集群</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop02 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-server-stop.sh stop</span>

<span class="token punctuation">[</span>root@hadoop03 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-server-stop.sh stop</span>

<span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-server-stop.sh stop</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_2-3-kafka命令行操作"><a href="#_2-3-kafka命令行操作" class="header-anchor">#</a> 2.3 Kafka命令行操作</h3> <p>1．查看当前服务器中的所有topic</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-topics.sh --zookeeper hadoop01:2181 --list</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2．创建topic</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-topics.sh --zookeeper hadoop01:2181 --create --replication-factor 3 --partitions 1 --topic first</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>选项说明：</p> <p>--topic ：定义topic名</p> <p>--replication-factor ：定义副本数</p> <p>--partitions ：定义分区数</p> <p>3．删除topic</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-topics.sh --zookeeper hadoop01:2181 --delete --topic first</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>需要server.properties中设置delete.topic.enable=true否则只是标记删除或者直接重启。</p> <p>4．发送消息</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-producer.sh --broker-list hadoop02:9092 --topic first</span>
<span class="token operator">&gt;</span>hello world
<span class="token operator">&gt;</span>from hadoop01
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>5．消费消息</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop02 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-consumer.sh --zookeeper hadoop01:2181 --from-beginning --topic first</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>--from-beginning：会把first主题中以往所有的数据都读取出来。根据业务场景选择是否增加该配置。</p> <p>6．查看某个Topic的详情</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-topics.sh --zookeeper hadoop01:2181 --describe --topic first</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2-4-kafka配置信息"><a href="#_2-4-kafka配置信息" class="header-anchor">#</a> 2.4 Kafka配置信息</h3> <h4 id="_2-4-1-broker配置信息"><a href="#_2-4-1-broker配置信息" class="header-anchor">#</a> 2.4.1 Broker配置信息</h4> <table><thead><tr><th>属性</th> <th>默认值</th> <th>描述</th></tr></thead> <tbody><tr><td>broker.id</td> <td></td> <td>必填参数，broker的唯一标识</td></tr> <tr><td>log.dirs</td> <td>/tmp/kafka-logs</td> <td>Kafka数据存放的目录。可以指定多个目录，中间用逗号分隔，当新partition被创建的时会被存放到当前存放partition最少的目录。</td></tr> <tr><td>port</td> <td>9092</td> <td>BrokerServer接受客户端连接的端口号</td></tr> <tr><td>zookeeper.connect</td> <td>null</td> <td>Zookeeper的连接串，格式为：hostname1:port1,hostname2:port2,hostname3:port3。可以填一个或多个，为了提高可靠性，建议都填上。注意，此配置允许我们指定一个zookeeper路径来存放此kafka集群的所有数据，为了与其他应用集群区分开，建议在此配置中指定本集群存放目录，格式为：hostname1:port1,hostname2:port2,hostname3:port3/chroot/path 。需要注意的是，消费者的参数要和此参数一致。</td></tr> <tr><td>message.max.bytes</td> <td>1000000</td> <td>服务器可以接收到的最大的消息大小。注意此参数要和consumer的maximum.message.size大小一致，否则会因为生产者生产的消息太大导致消费者无法消费。</td></tr> <tr><td>num.io.threads</td> <td>8</td> <td>服务器用来执行读写请求的IO线程数，此参数的数量至少要等于服务器上磁盘的数量。</td></tr> <tr><td>queued.max.requests</td> <td>500</td> <td>I/O线程可以处理请求的队列大小，若实际请求数超过此大小，网络线程将停止接收新的请求。</td></tr> <tr><td>socket.send.buffer.bytes</td> <td>100 * 1024</td> <td>The SO_SNDBUFF buffer the server prefers for socket connections.</td></tr> <tr><td>socket.receive.buffer.bytes</td> <td>100 * 1024</td> <td>The SO_RCVBUFF buffer the server prefers for socket connections.</td></tr> <tr><td>socket.request.max.bytes</td> <td>100 * 1024 * 1024</td> <td>服务器允许请求的最大值， 用来防止内存溢出，其值应该小于 Java heap size.</td></tr> <tr><td>num.partitions</td> <td>1</td> <td>默认partition数量，如果topic在创建时没有指定partition数量，默认使用此值，建议改为5</td></tr> <tr><td>log.segment.bytes</td> <td>1024 * 1024 * 1024</td> <td>Segment文件的大小，超过此值将会自动新建一个segment，此值可以被topic级别的参数覆盖。</td></tr> <tr><td>log.roll.{ms,hours}</td> <td>24 * 7 hours</td> <td>新建segment文件的时间，此值可以被topic级别的参数覆盖。</td></tr> <tr><td>log.retention.{ms,minutes,hours}</td> <td>7 days</td> <td>Kafka segment log的保存周期，保存周期超过此时间日志就会被删除。此参数可以被topic级别参数覆盖。数据量大时，建议减小此值。</td></tr> <tr><td>log.retention.bytes</td> <td>-1</td> <td>每个partition的最大容量，若数据量超过此值，partition数据将会被删除。注意这个参数控制的是每个partition而不是topic。此参数可以被log级别参数覆盖。</td></tr> <tr><td>log.retention.check.interval.ms</td> <td>5 minutes</td> <td>删除策略的检查周期</td></tr> <tr><td>auto.create.topics.enable</td> <td>true</td> <td>自动创建topic参数，建议此值设置为false，严格控制topic管理，防止生产者错写topic。</td></tr> <tr><td>default.replication.factor</td> <td>1</td> <td>默认副本数量，建议改为2。</td></tr> <tr><td>replica.lag.time.max.ms</td> <td>10000</td> <td>在此窗口时间内没有收到follower的fetch请求，leader会将其从ISR(in-sync replicas)中移除。</td></tr> <tr><td>replica.lag.max.messages</td> <td>4000</td> <td>如果replica节点落后leader节点此值大小的消息数量，leader节点就会将其从ISR中移除。</td></tr> <tr><td>replica.socket.timeout.ms</td> <td>30 * 1000</td> <td>replica向leader发送请求的超时时间。</td></tr> <tr><td>replica.socket.receive.buffer.bytes</td> <td>64 * 1024</td> <td>The socket receive buffer for network requests to the leader for replicating data.</td></tr> <tr><td>replica.fetch.max.bytes</td> <td>1024 * 1024</td> <td>The number of byes of messages to attempt to fetch for each partition in the fetch requests the replicas send to the leader.</td></tr> <tr><td>replica.fetch.wait.max.ms</td> <td>500</td> <td>The maximum amount of time to wait time for data to arrive on the leader in the fetch requests sent by the replicas to the leader.</td></tr> <tr><td>num.replica.fetchers</td> <td>1</td> <td>Number of threads used to replicate messages from leaders. Increasing this value can increase the degree of I/O parallelism in the follower broker.</td></tr> <tr><td>fetch.purgatory.purge.interval.requests</td> <td>1000</td> <td>The purge interval (in number of requests) of the fetch request purgatory.</td></tr> <tr><td>zookeeper.session.timeout.ms</td> <td>6000</td> <td>ZooKeeper session 超时时间。如果在此时间内server没有向zookeeper发送心跳，zookeeper就会认为此节点已挂掉。 此值太低导致节点容易被标记死亡；若太高，.会导致太迟发现节点死亡。</td></tr> <tr><td>zookeeper.connection.timeout.ms</td> <td>6000</td> <td>客户端连接zookeeper的超时时间。</td></tr> <tr><td>zookeeper.sync.time.ms</td> <td>2000</td> <td>H ZK follower落后 ZK leader的时间。</td></tr> <tr><td>controlled.shutdown.enable</td> <td>true</td> <td>允许broker shutdown。如果启用，broker在关闭自己之前会把它上面的所有leaders转移到其它brokers上，建议启用，增加集群稳定性。</td></tr> <tr><td>auto.leader.rebalance.enable</td> <td>true</td> <td>If this is enabled the controller will automatically try to balance leadership for partitions among the brokers by periodically returning leadership to the “preferred” replica for each partition if it is available.</td></tr> <tr><td>leader.imbalance.per.broker.percentage</td> <td>10</td> <td>The percentage of leader imbalance allowed per broker. The controller will rebalance leadership if this ratio goes above the configured value per broker.</td></tr> <tr><td>leader.imbalance.check.interval.seconds</td> <td>300</td> <td>The frequency with which to check for leader imbalance.</td></tr> <tr><td>offset.metadata.max.bytes</td> <td>4096</td> <td>The maximum amount of metadata to allow clients to save with their offsets.</td></tr> <tr><td>connections.max.idle.ms</td> <td>600000</td> <td>Idle connections timeout: the server socket processor threads close the connections that idle more than this.</td></tr> <tr><td>num.recovery.threads.per.data.dir</td> <td>1</td> <td>The number of threads per data directory to be used for log recovery at startup and flushing at shutdown.</td></tr> <tr><td>unclean.leader.election.enable</td> <td>true</td> <td>Indicates whether to enable replicas not in the ISR set to be elected as leader as a last resort, even though doing so may result in data loss.</td></tr> <tr><td>delete.topic.enable</td> <td>false</td> <td>启用deletetopic参数，建议设置为true。</td></tr> <tr><td>offsets.topic.num.partitions</td> <td>50</td> <td>The number of partitions for the offset commit topic. Since changing this after deployment is currently unsupported, we recommend using a higher setting for production (e.g., 100-200).</td></tr> <tr><td>offsets.topic.retention.minutes</td> <td>1440</td> <td>Offsets that are older than this age will be marked for deletion. The actual purge will occur when the log cleaner compacts the offsets topic.</td></tr> <tr><td>offsets.retention.check.interval.ms</td> <td>600000</td> <td>The frequency at which the offset manager checks for stale offsets.</td></tr> <tr><td>offsets.topic.replication.factor</td> <td>3</td> <td>The replication factor for the offset commit topic. A higher setting (e.g., three or four) is recommended in order to ensure higher availability. If the offsets topic is created when fewer brokers than the replication factor then the offsets topic will be created with fewer replicas.</td></tr> <tr><td>offsets.topic.segment.bytes</td> <td>104857600</td> <td>Segment size for the offsets topic. Since it uses a compacted topic, this should be kept relatively low in order to facilitate faster log compaction and loads.</td></tr> <tr><td>offsets.load.buffer.size</td> <td>5242880</td> <td>An offset load occurs when a broker becomes the offset manager for a set of consumer groups (i.e., when it becomes a leader for an offsets topic partition). This setting corresponds to the batch size (in bytes) to use when reading from the offsets segments when loading offsets into the offset manager’s cache.</td></tr> <tr><td>offsets.commit.required.acks</td> <td>-1</td> <td>The number of acknowledgements that are required before the offset commit can be accepted. This is similar to the producer’s acknowledgement setting. In general, the default should not be overridden.</td></tr> <tr><td>offsets.commit.timeout.ms</td> <td>5000</td> <td>The offset commit will be delayed until this timeout or the required number of replicas have received the offset commit. This is similar to the producer request timeout.</td></tr></tbody></table> <h4 id="_2-4-2-producer配置信息"><a href="#_2-4-2-producer配置信息" class="header-anchor">#</a> 2.4.2 Producer配置信息</h4> <table><thead><tr><th>属性</th> <th>默认值</th> <th>描述</th></tr></thead> <tbody><tr><td>metadata.broker.list</td> <td></td> <td>启动时producer查询brokers的列表，可以是集群中所有brokers的一个子集。注意，这个参数只是用来获取topic的元信息用，producer会从元信息中挑选合适的broker并与之建立socket连接。格式是：host1:port1,host2:port2。</td></tr> <tr><td>request.required.acks</td> <td>0</td> <td>参见3.2节介绍</td></tr> <tr><td>request.timeout.ms</td> <td>10000</td> <td>Broker等待ack的超时时间，若等待时间超过此值，会返回客户端错误信息。</td></tr> <tr><td>producer.type</td> <td>sync</td> <td>同步异步模式。async表示异步，sync表示同步。如果设置成异步模式，可以允许生产者以batch的形式push数据，这样会极大的提高broker性能，推荐设置为异步。</td></tr> <tr><td>serializer.class</td> <td>kafka.serializer.DefaultEncoder</td> <td>序列号类，.默认序列化成 byte[] 。</td></tr> <tr><td>key.serializer.class</td> <td></td> <td>Key的序列化类，默认同上。</td></tr> <tr><td>partitioner.class</td> <td>kafka.producer.DefaultPartitioner</td> <td>Partition类，默认对key进行hash。</td></tr> <tr><td>compression.codec</td> <td>none</td> <td>指定producer消息的压缩格式，可选参数为： “none”, “gzip” and “snappy”。关于压缩参见4.1节</td></tr> <tr><td>compressed.topics</td> <td>null</td> <td>启用压缩的topic名称。若上面参数选择了一个压缩格式，那么压缩仅对本参数指定的topic有效，若本参数为空，则对所有topic有效。</td></tr> <tr><td>message.send.max.retries</td> <td>3</td> <td>Producer发送失败时重试次数。若网络出现问题，可能会导致不断重试。</td></tr> <tr><td>retry.backoff.ms</td> <td>100</td> <td>Before each retry, the producer refreshes the metadata of relevant topics to see if a new leader has been elected. Since leader election takes a bit of time, this property specifies the amount of time that the producer waits before refreshing the metadata.</td></tr> <tr><td>topic.metadata.refresh.interval.ms</td> <td>600 * 1000</td> <td>The producer generally refreshes the topic metadata from brokers when there is a failure (partition missing, leader not available…). It will also poll regularly (default: every 10min so 600000ms). If you set this to a negative value, metadata will only get refreshed on failure. If you set this to zero, the metadata will get refreshed after each message sent (not recommended). Important note: the refresh happen only AFTER the message is sent, so if the producer never sends a message the metadata is never refreshed</td></tr> <tr><td>queue.buffering.max.ms</td> <td>5000</td> <td>启用异步模式时，producer缓存消息的时间。比如我们设置成1000时，它会缓存1秒的数据再一次发送出去，这样可以极大的增加broker吞吐量，但也会造成时效性的降低。</td></tr> <tr><td>queue.buffering.max.messages</td> <td>10000</td> <td>采用异步模式时producer buffer 队列里最大缓存的消息数量，如果超过这个数值，producer就会阻塞或者丢掉消息。</td></tr> <tr><td>queue.enqueue.timeout.ms</td> <td>-1</td> <td>当达到上面参数值时producer阻塞等待的时间。如果值设置为0，buffer队列满时producer不会阻塞，消息直接被丢掉。若值设置为-1，producer会被阻塞，不会丢消息。</td></tr> <tr><td>batch.num.messages</td> <td>200</td> <td>采用异步模式时，一个batch缓存的消息数量。达到这个数量值时producer才会发送消息。</td></tr> <tr><td>send.buffer.bytes</td> <td>100 * 1024</td> <td>Socket write buffer size</td></tr> <tr><td>client.id</td> <td>“”</td> <td>The client id is a user-specified string sent in each request to help trace calls. It should logically identify the application making the request.</td></tr></tbody></table> <h4 id="_2-4-3-consumer配置信息"><a href="#_2-4-3-consumer配置信息" class="header-anchor">#</a> 2.4.3 Consumer配置信息</h4> <table><thead><tr><th>属性</th> <th>默认值</th> <th>描述</th></tr></thead> <tbody><tr><td>group.id</td> <td></td> <td>Consumer的组ID，相同goup.id的consumer属于同一个组。</td></tr> <tr><td>zookeeper.connect</td> <td></td> <td>Consumer的zookeeper连接串，要和broker的配置一致。</td></tr> <tr><td>consumer.id</td> <td>null</td> <td>如果不设置会自动生成。</td></tr> <tr><td>socket.timeout.ms</td> <td>30 * 1000</td> <td>网络请求的socket超时时间。实际超时时间由max.fetch.wait + socket.timeout.ms 确定。</td></tr> <tr><td>socket.receive.buffer.bytes</td> <td>64 * 1024</td> <td>The socket receive buffer for network requests.</td></tr> <tr><td>fetch.message.max.bytes</td> <td>1024 * 1024</td> <td>查询topic-partition时允许的最大消息大小。consumer会为每个partition缓存此大小的消息到内存，因此，这个参数可以控制consumer的内存使用量。这个值应该至少比server允许的最大消息大小大，以免producer发送的消息大于consumer允许的消息。</td></tr> <tr><td>num.consumer.fetchers</td> <td>1</td> <td>The number fetcher threads used to fetch data.</td></tr> <tr><td>auto.commit.enable</td> <td>true</td> <td>如果此值设置为true，consumer会周期性的把当前消费的offset值保存到zookeeper。当consumer失败重启之后将会使用此值作为新开始消费的值。</td></tr> <tr><td>auto.commit.interval.ms</td> <td>60 * 1000</td> <td>Consumer提交offset值到zookeeper的周期。</td></tr> <tr><td>queued.max.message.chunks</td> <td>2</td> <td>用来被consumer消费的message chunks 数量， 每个chunk可以缓存fetch.message.max.bytes大小的数据量。</td></tr> <tr><td>auto.commit.interval.ms</td> <td>60 * 1000</td> <td>Consumer提交offset值到zookeeper的周期。</td></tr> <tr><td>queued.max.message.chunks</td> <td>2</td> <td>用来被consumer消费的message chunks 数量， 每个chunk可以缓存fetch.message.max.bytes大小的数据量。</td></tr> <tr><td>fetch.min.bytes</td> <td>1</td> <td>The minimum amount of data the server should return for a fetch request. If insufficient data is available the request will wait for that much data to accumulate before answering the request.</td></tr> <tr><td>fetch.wait.max.ms</td> <td>100</td> <td>The maximum amount of time the server will block before answering the fetch request if there isn’t sufficient data to immediately satisfy fetch.min.bytes.</td></tr> <tr><td>rebalance.backoff.ms</td> <td>2000</td> <td>Backoff time between retries during rebalance.</td></tr> <tr><td>refresh.leader.backoff.ms</td> <td>200</td> <td>Backoff time to wait before trying to determine the leader of a partition that has just lost its leader.</td></tr> <tr><td>auto.offset.reset</td> <td>largest</td> <td>What to do when there is no initial offset in ZooKeeper or if an offset is out of range ;smallest : automatically reset the offset to the smallest offset; largest : automatically reset the offset to the largest offset;anything else: throw exception to the consumer</td></tr> <tr><td>consumer.timeout.ms</td> <td>-1</td> <td>若在指定时间内没有消息消费，consumer将会抛出异常。</td></tr> <tr><td>exclude.internal.topics</td> <td>true</td> <td>Whether messages from internal topics (such as offsets) should be exposed to the consumer.</td></tr> <tr><td>zookeeper.session.timeout.ms</td> <td>6000</td> <td>ZooKeeper session timeout. If the consumer fails to heartbeat to ZooKeeper for this period of time it is considered dead and a rebalance will occur.</td></tr> <tr><td>zookeeper.connection.timeout.ms</td> <td>6000</td> <td>The max time that the client waits while establishing a connection to zookeeper.</td></tr> <tr><td>zookeeper.sync.time.ms</td> <td>2000</td> <td>How far a ZK follower can be behind a ZK leader</td></tr></tbody></table> <h2 id="第3章-kafka工作流程分析"><a href="#第3章-kafka工作流程分析" class="header-anchor">#</a> 第3章 Kafka工作流程分析</h2> <p>Kafka工作流程分析如图所示。</p> <p><img src="/assets/img/Kafka工作流程分析.5bfa4568.png" alt="img"></p> <h3 id="_3-1-kafka生产过程分析"><a href="#_3-1-kafka生产过程分析" class="header-anchor">#</a> 3.1 Kafka生产过程分析</h3> <h4 id="_3-1-1-写入方式"><a href="#_3-1-1-写入方式" class="header-anchor">#</a> 3.1.1 写入方式</h4> <p>producer采用推（push）模式将消息发布到broker，每条消息都被追加（append）到分区（patition）中，属于顺序写磁盘（顺序写磁盘效率比随机写内存要高，保障kafka吞吐率）。</p> <h4 id="_3-1-2-分区-partition"><a href="#_3-1-2-分区-partition" class="header-anchor">#</a> 3.1.2 分区（Partition）</h4> <p>消息发送时都被发送到一个topic，其本质就是一个目录，而topic是由一些Partition Logs(分区日志)组成，其组织结构如图所示：</p> <p><img src="/assets/img/Topic内部结构.8485a511.png" alt="image-20230720135953805"></p> <p>图8-5 Topic的内部结构</p> <p><img src="/assets/img/Topic的Partition.6c8898ca.png" alt="image-20230720140024433"></p> <p>图8-6 Partition</p> <p>我们可以看到，每个Partition中的消息都是有序的，生产的消息被不断追加到Partition log上，其中的每一个消息都被赋予了一个唯一的offset值。</p> <p>1．分区的原因</p> <p>（1）方便在集群中扩展，每个Partition可以通过调整以适应它所在的机器，而一个topic又可以有多个Partition组成，因此整个集群就可以适应任意大小的数据了。</p> <p>（2）可以提高并发，因为可以以Partition为单位读写了。</p> <p>2．分区的原则</p> <p>（1）指定了patition，则直接采用自定义的分区规则；</p> <p>（2）未指定patition但指定key，通过对key的value进行hash出一个patition</p> <p>（3）patition和key都未指定，使用轮询选出一个patition。</p> <p>DefaultPartitioner类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">int</span> nextValue <span class="token operator">=</span> <span class="token function">nextValue</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> availablePartitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">availablePartitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    		<span class="token keyword">int</span> part <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token operator">%</span> availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token keyword">return</span> availablePartitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    		<span class="token comment">// no partitions are available, give a non-available partition</span>
    		<span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    	<span class="token comment">// hash the keyBytes to choose a partition</span>
    	<span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_3-1-3-副本-replication"><a href="#_3-1-3-副本-replication" class="header-anchor">#</a> 3.1.3 副本（Replication）</h4> <p>同一个partition可能会有多个replication（对应 server.properties 配置中的 default.replication.factor=N）。没有replication的情况下，一旦broker 宕机，其上所有 patition 的数据都不可被消费，同时producer也不能再将数据存于其上的patition。引入replication之后，同一个partition可能会有多个replication，而这时需要在这些replication之间选出一个leader，producer和consumer只与这个leader交互，其它replication作为follower从leader中复制数据。</p> <h4 id="_3-1-4-写入流程"><a href="#_3-1-4-写入流程" class="header-anchor">#</a> 3.1.4 写入流程</h4> <p>producer写入消息流程如图所示：</p> <p><img src="/assets/img/Producer写入消息流程.49d35c61.png" alt="img"></p> <p>1）producer先从zookeeper的 &quot;/brokers/.../state&quot;节点找到该partition的leader</p> <p>2）producer将消息发送给该leader</p> <p>3）leader将消息写入本地log</p> <p>4）followers从leader pull消息，写入本地log后向leader发送ACK</p> <p>5）leader收到所有ISR中的replication的ACK后，增加HW（high watermark，最后commit 的offset）并向producer发送ACK</p> <h3 id="_3-2-broker-保存消息"><a href="#_3-2-broker-保存消息" class="header-anchor">#</a> 3.2 Broker 保存消息</h3> <h4 id="_3-2-1-存储方式"><a href="#_3-2-1-存储方式" class="header-anchor">#</a> 3.2.1 存储方式</h4> <p>物理上把topic分成一个或多个patition（对应 server.properties 中的num.partitions=3配置），每个patition物理上对应一个文件夹（该文件夹存储该patition的所有消息和索引文件），如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 logs<span class="token punctuation">]</span><span class="token comment"># ll</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>drwxrwxr-x. 2 root root 4096 8月 6 14:37 first-0
drwxrwxr-x. 2 root root 4096 8月 6 14:35 first-1
drwxrwxr-x. 2 root root 4096 8月 6 14:37 first-2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 logs<span class="token punctuation">]</span><span class="token comment"># cd first-0</span>
<span class="token punctuation">[</span>root@hadoop01 first-0<span class="token punctuation">]</span><span class="token comment"># ll</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>-rw-rw-r--. 1 root root 10485760 8月 6 14:33 00000000000000000000.index
-rw-rw-r--. 1 root root 219 8月 6 15:07 00000000000000000000.log
-rw-rw-r--. 1 root root 10485756 8月 6 14:33 00000000000000000000.timeindex
-rw-rw-r--. 1 root root 8 8月 6 14:37 leader-epoch-checkpoint
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_3-2-2-存储策略"><a href="#_3-2-2-存储策略" class="header-anchor">#</a> 3.2.2 存储策略</h4> <p>无论消息是否被消费，kafka都会保留所有消息。有两种策略可以删除旧数据：</p> <p>1）基于时间：log.retention.hours=168</p> <p>2）基于大小：log.retention.bytes=1073741824</p> <p>需要注意的是，因为Kafka读取特定消息的时间复杂度为O(1)，即与文件大小无关，所以这里删除过期文件与提高 Kafka 性能无关。</p> <h4 id="_3-2-3-zookeeper存储结构"><a href="#_3-2-3-zookeeper存储结构" class="header-anchor">#</a> 3.2.3 Zookeeper存储结构</h4> <p>Zookeeper存储结构如图所示。</p> <p><img src="/assets/img/Zookeeper存储结构.ab5e07bf.png" alt="image-20230720142855390"></p> <p>注意：producer不在zk中注册，消费者在zk中注册。</p> <h3 id="_3-3-kafka消费过程分析。"><a href="#_3-3-kafka消费过程分析。" class="header-anchor">#</a> 3.3 Kafka消费过程分析。</h3> <h4 id="_3-3-1-消费者组"><a href="#_3-3-1-消费者组" class="header-anchor">#</a> 3.3.1 消费者组</h4> <p><img src="/assets/img/消费者组.01aa9229.png" alt="img"></p> <p>消费者是以consumer group消费者组的方式工作，由一个或者多个消费者组成一个组，共同消费一个topic。每个分区在同一时间只能由group中的一个消费者读取，但是多个group可以同时消费这个partition。如图所示，有一个由三个消费者组成的group，有一个消费者读取主题中的两个分区，另外两个分别读取一个分区。某个消费者读取某个分区，也可以叫做某个消费者是某个分区的拥有者。</p> <p>在这种情况下，消费者可以通过水平扩展的方式同时读取大量的消息。另外，如果一个消费者失败了，那么其他的group成员会自动负载均衡读取之前失败的消费者读取的分区。</p> <h4 id="_3-3-2-消费方式"><a href="#_3-3-2-消费方式" class="header-anchor">#</a> 3.3.2 消费方式</h4> <p>consumer采用pull（拉）模式从broker中读取数据。</p> <p>push（推）模式很难适应消费速率不同的消费者，因为消息发送速率是由broker决定的。它的目标是尽可能以最快速度传递消息，但是这样很容易造成consumer来不及处理消息，典型的表现就是拒绝服务以及网络拥塞。而pull模式则可以根据consumer的消费能力以适当的速率消费消息。</p> <p>对于Kafka而言，pull模式更合适，它可简化broker的设计，consumer可自主控制消费消息的速率，同时consumer可以自己控制消费方式——即可批量消费也可逐条消费，同时还能选择不同的提交方式从而实现不同的传输语义。</p> <p>pull模式不足之处是，如果kafka没有数据，消费者可能会陷入循环中，一直等待数据到达。为了避免这种情况，我们在我们的拉请求中有参数，允许消费者请求在等待数据到达的“长轮询”中进行阻塞（并且可选地等待到给定的字节数，以确保大的传输大小）。</p> <h4 id="_3-3-3-消费者组案例"><a href="#_3-3-3-消费者组案例" class="header-anchor">#</a> 3.3.3 消费者组案例</h4> <p>1．需求</p> <p>测试同一个消费者组中的消费者，同一时刻只能有一个消费者消费。</p> <p>2．案例实操</p> <p>（1）在hadoop02、hadoop03上修改/opt/module/kafka/config/consumer.properties配置文件中的group.id属性为任意组名。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 config<span class="token punctuation">]</span><span class="token comment"># vi consumer.properties</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>group.id=HadoopGroup
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>（2）在hadoop02、hadoop03上分别启动消费者</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop02 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-consumer.sh --zookeeper hadoop02:2181 --topic first --consumer.config config/consumer.properties</span>

<span class="token punctuation">[</span>root@hadoop03 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-consumer.sh --zookeeper hadoop03:2181 --topic first --consumer.config config/consumer.properties</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>（3）在hadoop02上启动生产者</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop04 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-producer.sh --broker-list hadoop02:9092 --topic first</span>

<span class="token operator">&gt;</span>hello world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>（4）查看hadoop02和hadoop03的接收者。</p> <p>同一时刻只有一个消费者接收到消息。</p> <h2 id="第4章-kafkaapi实战"><a href="#第4章-kafkaapi实战" class="header-anchor">#</a> 第4章 KafkaAPI实战</h2> <h3 id="_4-1-环境准备"><a href="#_4-1-环境准备" class="header-anchor">#</a> 4.1 环境准备</h3> <p>1．在idea中创建一个java工程并导入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.11.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-streams<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.11.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>2．启动zk和kafka集群，在kafka集群中打开一个消费者</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-consumer.sh --zookeeper hadoop01:2181 --topic first</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_4-2-kafka生产者java-api"><a href="#_4-2-kafka生产者java-api" class="header-anchor">#</a> 4.2 Kafka生产者Java API</h3> <h4 id="_4-2-1-创建生产者"><a href="#_4-2-1-创建生产者" class="header-anchor">#</a> 4.2.1 创建生产者</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>saint<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">Producer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NewProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Kafka服务端的主机名和端口号</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hadoop01:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//等待所有副本节点的应答</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;acks&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息发送最大尝试次数</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//一批消息处理大小,2的14次</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;batch.size&quot;</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求延时</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;linger.ms&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送缓存区内存大小，2的25次，32M</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;buffer.memory&quot;</span><span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//key序列化</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//value序列化</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world-&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="_4-2-2-创建生产者带回调函数"><a href="#_4-2-2-创建生产者带回调函数" class="header-anchor">#</a> 4.2.2 创建生产者带回调函数</h4> <p>基于上例生产者，在producer.send的参数中追加Callback对象</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world-&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>recordMetadata <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>recordMetadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;---&quot;</span> <span class="token operator">+</span> recordMetadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_4-2-3-自定义分区生产者"><a href="#_4-2-3-自定义分区生产者" class="header-anchor">#</a> 4.2.3 自定义分区生产者</h4> <p>1．需求</p> <p>将所有数据存储到topic的第0号分区上</p> <p>2．定义一个类实现Partitioner接口，重写里面的方法（过时API）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hotdas<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">kafka<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">Partitioner</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomPartitioner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//控制分区</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>3．自定义分区（新API）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hotdas<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">Partitioner</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Cluster</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">//控制分区</span>
    	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>4．在代码中调用，属性添加编写分区逻辑的类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//自定义分区</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;partitioner.class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;com.saint.kafka.CustomPartitioner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>5．测试</p> <p>（1）在hadoop01上监控/opt/module/kafka/logs/目录下first主题3个分区的log日志动态变化情况</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 first-0<span class="token punctuation">]</span><span class="token comment"># tail -f 00000000000000000000.log</span>

<span class="token punctuation">[</span>root@hadoop01 first-1<span class="token punctuation">]</span><span class="token comment"># tail -f 00000000000000000000.log</span>

<span class="token punctuation">[</span>root@hadoop01 first-2<span class="token punctuation">]</span><span class="token comment"># tail -f 00000000000000000000.log</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>（2）发现数据都存储到指定的分区了。</p> <h3 id="_4-3-kafka消费者java-api"><a href="#_4-3-kafka消费者java-api" class="header-anchor">#</a> 4.3 Kafka消费者Java API</h3> <p>1．在控制台创建发送者，上面例子有了可以不做</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-producer.sh --broker-list hadoop01:9092 --topic first</span>
<span class="token operator">&gt;</span> hello world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2．案例（自动维护消费情况）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>saint<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NewConsumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//定义kafka 服务的地址，不需要将所有broker指定上</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop01:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//制定consumer group</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//是否自动确认offset</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//自动确认offset的时间间隔</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//key的序列化类</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//value的序列化类</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//定义consumer</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指定要消费的topic, 可同时处理多个</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//读取数据，读取超时时间为100ms</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="第5章-kafka-producer拦截器-interceptor"><a href="#第5章-kafka-producer拦截器-interceptor" class="header-anchor">#</a> 第5章 Kafka producer拦截器(interceptor)</h2> <h3 id="_5-1-拦截器原理"><a href="#_5-1-拦截器原理" class="header-anchor">#</a> 5.1 拦截器原理</h3> <p>Producer拦截器(interceptor)是在Kafka 0.10版本被引入的，主要用于实现clients端的定制化控制逻辑。</p> <p>对于producer而言，interceptor使得用户在消息发送前以及producer回调逻辑前有机会对消息做一些定制化需求，比如修改消息等。同时，producer允许用户指定多个interceptor按序作用于同一条消息从而形成一个拦截链(interceptor chain)。Intercetpor的实现接口是org.apache.kafka.clients.producer.ProducerInterceptor，其定义的方法包括：</p> <p>（1）configure(configs)</p> <p>获取配置信息和初始化数据时调用。</p> <p>（2）onSend(ProducerRecord)：</p> <p>该方法封装进KafkaProducer.send方法中，即它运行在用户主线程中。Producer确保在消息被序列化以及计算分区前调用该方法。用户可以在该方法中对消息做任何操作，但最好保证不要修改消息所属的topic和分区，否则会影响目标分区的计算</p> <p>（3）onAcknowledgement(RecordMetadata, Exception)：</p> <p>该方法会在消息被应答或消息发送失败时调用，并且通常都是在producer回调逻辑触发之前。onAcknowledgement运行在producer的IO线程中，因此不要在该方法中放入很重的逻辑，否则会拖慢producer的消息发送效率</p> <p>（4）close：</p> <p>关闭interceptor，主要用于执行一些资源清理工作</p> <p>如前所述，interceptor可能被运行在多个线程中，因此在具体实现时用户需要自行确保线程安全。另外倘若指定了多个interceptor，则producer将按照指定顺序调用它们，并仅仅是捕获每个interceptor可能抛出的异常记录到错误日志中而非在向上传递。这在使用过程中要特别留意。</p> <h3 id="_5-2-拦截器案例"><a href="#_5-2-拦截器案例" class="header-anchor">#</a> 5.2 拦截器案例</h3> <p>1．需求</p> <p>实现一个简单的双interceptor组成的拦截链。第一个interceptor会在消息发送前将时间戳信息加到消息value的最前部；第二个interceptor会在消息发送后更新成功发送消息数或失败发送消息数，如图所示。</p> <p><img src="/assets/img/Kafka拦截器.3a9a5a44.png" alt="img"></p> <p>2．案例实操</p> <p>（1）增加时间戳拦截器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>saint<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>interceptor</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">RecordMetadata</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerInterceptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">onSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建新的ProducerRecord，把时间戳加到消息的前面</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//为了美观转化成Date类，可以直接用时间戳</span>
                <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>（2）统计发送消息成功和发送失败消息数，并在producer关闭时打印这两个计数器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>saint<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>interceptor</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">RecordMetadata</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CounterInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerInterceptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> errorCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> successCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">onSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> producerRecord<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 统计成功和失败的次数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            successCounter<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            errorCounter<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 保存结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Successful Sent: &quot;</span> <span class="token operator">+</span> successCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Failed Sent: &quot;</span> <span class="token operator">+</span> errorCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>（3）producer主程序</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>saint<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>interceptor</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Saint
 * @date 7/20/2023
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Kafka服务端的主机名和端口号</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hadoop02:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//等待所有副本节点的应答</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;acks&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息发送最大尝试次数</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//一批消息处理大小,2的14次</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;batch.size&quot;</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求延时</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;linger.ms&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送缓存区内存大小，2的25次，32M</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;buffer.memory&quot;</span><span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//key序列化</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//value序列化</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//构建拦截链</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;com.saint.kafka.interceptor.TimeInterceptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;com.saint.kafka.interceptor.CounterInterceptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//例子为了体现拦截链写了两个拦截器，可以尝试写作一个，毕竟拦截面不冲突</span>
        <span class="token comment">//interceptors.add(&quot;com.saint.kafka.interceptor.Interceptor&quot;);</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">INTERCEPTOR_CLASSES_CONFIG</span><span class="token punctuation">,</span> interceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">&quot;first&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;message&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//关闭资源</span>
        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>3．测试</p> <p>（1）在kafka上启动消费者，然后运行客户端java程序。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@hadoop01 kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-consumer.sh --zookeeper hadoop01:2181 --from-beginning --topic first</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>Thu Jul 20 18:09:23 GMT+08:00 2023, message0
Thu Jul 20 18:09:23 GMT+08:00 2023, message1
Thu Jul 20 18:09:23 GMT+08:00 2023, message2
Thu Jul 20 18:09:23 GMT+08:00 2023, message3
Thu Jul 20 18:09:23 GMT+08:00 2023, message4
Thu Jul 20 18:09:23 GMT+08:00 2023, message5
Thu Jul 20 18:09:23 GMT+08:00 2023, message6
Thu Jul 20 18:09:23 GMT+08:00 2023, message7
Thu Jul 20 18:09:23 GMT+08:00 2023, message8
Thu Jul 20 18:09:23 GMT+08:00 2023, message9

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>（2）观察java平台控制台输出数据如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Successful Sent: 10
Failed Sent: 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#第1章-kafka概述" class="sidebar-link reco-side-第1章-kafka概述" data-v-b57cc07c>第1章 Kafka概述</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_1-1-kafka是什么" class="sidebar-link reco-side-_1-1-kafka是什么" data-v-b57cc07c>1.1 Kafka是什么</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_1-2-消息队列内部实现原理" class="sidebar-link reco-side-_1-2-消息队列内部实现原理" data-v-b57cc07c>1.2 消息队列内部实现原理</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_1-3-为什么需要消息队列" class="sidebar-link reco-side-_1-3-为什么需要消息队列" data-v-b57cc07c>1.3 为什么需要消息队列</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_1-4-kafka架构" class="sidebar-link reco-side-_1-4-kafka架构" data-v-b57cc07c>1.4 Kafka架构</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#第2章-kafka集群部署" class="sidebar-link reco-side-第2章-kafka集群部署" data-v-b57cc07c>第2章 Kafka集群部署</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_2-1-环境准备" class="sidebar-link reco-side-_2-1-环境准备" data-v-b57cc07c>2.1 环境准备</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_2-2-kafka集群部署" class="sidebar-link reco-side-_2-2-kafka集群部署" data-v-b57cc07c>2.2 Kafka集群部署</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_2-3-kafka命令行操作" class="sidebar-link reco-side-_2-3-kafka命令行操作" data-v-b57cc07c>2.3 Kafka命令行操作</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_2-4-kafka配置信息" class="sidebar-link reco-side-_2-4-kafka配置信息" data-v-b57cc07c>2.4 Kafka配置信息</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#第3章-kafka工作流程分析" class="sidebar-link reco-side-第3章-kafka工作流程分析" data-v-b57cc07c>第3章 Kafka工作流程分析</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_3-1-kafka生产过程分析" class="sidebar-link reco-side-_3-1-kafka生产过程分析" data-v-b57cc07c>3.1 Kafka生产过程分析</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_3-2-broker-保存消息" class="sidebar-link reco-side-_3-2-broker-保存消息" data-v-b57cc07c>3.2 Broker 保存消息</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_3-3-kafka消费过程分析。" class="sidebar-link reco-side-_3-3-kafka消费过程分析。" data-v-b57cc07c>3.3 Kafka消费过程分析。</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#第4章-kafkaapi实战" class="sidebar-link reco-side-第4章-kafkaapi实战" data-v-b57cc07c>第4章 KafkaAPI实战</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_4-1-环境准备" class="sidebar-link reco-side-_4-1-环境准备" data-v-b57cc07c>4.1 环境准备</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_4-2-kafka生产者java-api" class="sidebar-link reco-side-_4-2-kafka生产者java-api" data-v-b57cc07c>4.2 Kafka生产者Java API</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_4-3-kafka消费者java-api" class="sidebar-link reco-side-_4-3-kafka消费者java-api" data-v-b57cc07c>4.3 Kafka消费者Java API</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#第5章-kafka-producer拦截器-interceptor" class="sidebar-link reco-side-第5章-kafka-producer拦截器-interceptor" data-v-b57cc07c>第5章 Kafka producer拦截器(interceptor)</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_5-1-拦截器原理" class="sidebar-link reco-side-_5-1-拦截器原理" data-v-b57cc07c>5.1 拦截器原理</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/BigData/Kafka/Kafka.html#_5-2-拦截器案例" class="sidebar-link reco-side-_5-2-拦截器案例" data-v-b57cc07c>5.2 拦截器案例</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><div class="RibbonAnimation"></div><div></div></div></div>
    <script src="/assets/js/app.4c955a77.js" defer></script><script src="/assets/js/4.1f64e010.js" defer></script><script src="/assets/js/1.2b09ee83.js" defer></script><script src="/assets/js/10.08341258.js" defer></script>
  </body>
</html>
